import spotipy
from spotipy.oauth2 import SpotifyOAuth
import random
auth_manager = SpotifyOAuth(client_id="enter client_id",
                            client_secret="enter client_secret",
                            redirect_uri="http://google.com/",
                            scope="user-library-read user-top-read playlist-modify-public user-follow-read")
class SpotifyBot:
    def __init__(self):
        self.spotify = spotipy.Spotify(auth_manager=auth_manager)
        self.user_id = '31ojsle5q4bh3bewzlqqy32xazuu'
    # pulls the data for my most listened to artists and adds the artist id to a array
    def top_artists_id(self):
        top_artists = self.spotify.current_user_top_artists(limit=20)
        artists_ids = []
        for artists in top_artists["items"]:
            artists_ids.append(artists['id'])
        return artists_ids
    #takes artist data makes api call to spotify returning list of songs
    def pull_songs(self, artist_list):
        final_song_list = []
        for artists_id in artist_list:
            top_songs = self.spotify.artist_top_tracks(artists_id, "US")
            for songs in top_songs["tracks"]:
                random_select = random.getrandbits(1)
                if random_select == 0:
                    final_song_list.append(songs["id"])
        return final_song_list
    #gets list of favorite artists then creates playlist from these artists
    def create_favorite_artists(self):
        artist_list = self.top_artists_id()
        song_list = self.pull_songs(artist_list)
        playlist_name = "Top Artists Playlist (Python)"
        self.create_playlist(song_list, playlist_name)
    #gets list of related artists then creates playlist from these artists
    def create_related_artists(self, artists_id):
        find_artists = self.spotify.artist_related_artists(artists_id)
        related_artists = []
        for artist in find_artists['artists']:
            related_artists.append(artist['id'])
        related_songs = self.pull_songs(related_artists)
        playlist_name = "Related Artists Playlist (Python)"
        self.create_playlist(related_songs, playlist_name)
    # gets list of followed artists then creates playlist from these artists
    def create_follow_artists(self):
        followed_artists = self.spotify.current_user_followed_artists()
        followed_artists_ids = []
        for artists in followed_artists['artists']['items']:
            followed_artists_ids.append(artists['id'])
        followed_artists_songs = self.pull_songs(followed_artists_ids)
        playlist_name = "Followed Artists Playlist (Python)"
        self.create_playlist(followed_artists_songs, playlist_name)
    #takes list of song data then creates playlist with given name
    def create_playlist(self, songData, playlistName):
        random.shuffle(songData)
        while len(songData) > 100:
            songData.pop()
        try:
            playlist = self.spotify.user_playlist_create(self.user_id, playlistName, public=True, collaborative=False, description='Playlist generated by python and spotipy api')
            self.spotify.playlist_add_items(playlist['id'], songData, position=None)
            print(f"Successfully created {playlistName}!!!")
        except:
            print("Failed to create one of the playlists")
spotify_bot = SpotifyBot()
the_smiths = "3yY2gUcIsjMr8hjo51PoJ8"
spotify_bot.create_favorite_artists()
spotify_bot.create_related_artists(the_smiths)
spotify_bot.create_follow_artists()

